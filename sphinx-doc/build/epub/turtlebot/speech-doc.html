<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Turtlebot Voice Teleoperation</title>
    
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 
  </head>
  <body role="document">

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../drones/index.html" title="Drones"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="turtlebot-first-tests.html" title="Turtlebot First Tests"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Gaitech Doc 2.5 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="turtlebot-tutorials.html" accesskey="U">Turtlebot Quick Start Tutorials</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="turtlebot-voice-teleoperation">
<span id="speech-doc"></span><h1>Turtlebot Voice Teleoperation</h1>
<p>This tutorial will introduce how to control your turtlebot robot using speech recognition.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure that you completed installing all the required packages in the previous tutorials and your network set-up is working fine between the ROS Master node and the host node.</p>
</div>
<p>In this tutorial you will learn how to:</p>
<blockquote>
<div><ul class="simple">
<li>Teleoprate a real and simulated turtlebot with voice commands</li>
<li>Create a custom voice-command vocabulary</li>
<li>Work with pocket-sphinx package in ROS</li>
</ul>
</div></blockquote>
<div class="section" id="install-pocketsphinx-for-speech-recognition">
<h2>Install PocketSphinx for Speech Recognition</h2>
<p>In order to download the <code class="docutils literal"><span class="pre">pocketsphinx</span></code> package on Ubuntu you need to install the <code class="docutils literal"><span class="pre">gstreamer0.10-pocketsphinx</span></code> and the ROS sound drivers.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">gstreamer0</span><span class="o">.</span><span class="mi">10</span><span class="o">-</span><span class="n">pocketsphinx</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">ros</span><span class="o">-</span><span class="n">indigo</span><span class="o">-</span><span class="n">pocketsphinx</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">ros</span><span class="o">-</span><span class="n">indigo</span><span class="o">-</span><span class="n">audio</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libasound2</span>
</pre></div>
</div>
<p>You do not need to worry about connecting the audio input stream with your PC or publishing a topic because the node recognizer.py in the <code class="docutils literal"><span class="pre">pocketsphinx</span></code> package does all the work for you.</p>
</div>
<div class="section" id="test-the-pocketsphinx-recognizer">
<h2>Test the PocketSphinx Recognizer</h2>
<p>First, you need to test of the recognizer is working. To get the best result it is better to have an external Mic connected to you PC either by USB, standard audio or Bluetooth.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure that the Mic you are using is the one that is selected in the sound settings in your PC. Try to test your Mic before hands to make sure that the quality is good and check the volume meter.</p>
</div>
<p>Note that <code class="docutils literal"><span class="pre">pocketsphinx</span></code> comes as a packages in ROS Indigo. For more details, refer to <a class="reference external" href="http://wiki.ros.org/pocketsphinx">the pocketsphinx package</a><span class="link-target"> [http://wiki.ros.org/pocketsphinx]</span> on ROS WiKi.
You can find browse the directory of <code class="docutils literal"><span class="pre">pocketsphinx</span></code> package with the command:</p>
<div class="highlight-linux"><div class="highlight"><pre><span></span>roscd pocketsphinx
</pre></div>
</div>
<p>In the directory <code class="docutils literal"><span class="pre">demo/</span></code>, you can observe the voice commands and dictionary. You may want to have a look at their content using <code class="docutils literal"><span class="pre">more</span></code> or <code class="docutils literal"><span class="pre">nano</span></code> text viewers.
Then, run the following command:</p>
<div class="highlight-linux"><div class="highlight"><pre><span></span>roslaunch pocketsphinx robocup.launch
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">robocup.dic</span></code> contains the following code:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;launch&gt;</span>
  <span class="nt">&lt;node</span> <span class="na">name=</span><span class="s">&quot;recognizer&quot;</span> <span class="na">pkg=</span><span class="s">&quot;pocketsphinx&quot;</span> <span class="na">type=</span><span class="s">&quot;recognizer.py&quot;</span> <span class="na">output=</span><span class="s">&quot;screen&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;lm&quot;</span> <span class="na">value=</span><span class="s">&quot;$(find pocketsphinx)/demo/robocup.lm&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;dict&quot;</span> <span class="na">value=</span><span class="s">&quot;$(find pocketsphinx)/demo/robocup.dic&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/node&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></div>
</div>
<p>This command will run the <code class="docutils literal"><span class="pre">recognizer.py</span></code> script with loading the dictionary <code class="docutils literal"><span class="pre">robocup.dic</span></code>.
A list of INFO messages will appear showing the loading of the recognition model. The last few messages will look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span> <span class="n">ngram_search_fwdtree</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">186</span><span class="p">):</span> <span class="n">Creating</span> <span class="n">search</span> <span class="n">tree</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">ngram_search_fwdtree</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">191</span><span class="p">):</span> <span class="n">before</span><span class="p">:</span> <span class="mi">0</span> <span class="n">root</span><span class="p">,</span> <span class="mi">0</span> <span class="n">non</span><span class="o">-</span><span class="n">root</span> <span class="n">channels</span><span class="p">,</span> <span class="mi">12</span> <span class="n">single</span><span class="o">-</span><span class="n">phone</span> <span class="n">words</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">ngram_search_fwdtree</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">326</span><span class="p">):</span> <span class="n">after</span><span class="p">:</span> <span class="nb">max</span> <span class="n">nonroot</span> <span class="n">chan</span> <span class="n">increased</span> <span class="n">to</span> <span class="mi">328</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">ngram_search_fwdtree</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="mi">338</span><span class="p">):</span> <span class="n">after</span><span class="p">:</span> <span class="mi">77</span> <span class="n">root</span><span class="p">,</span> <span class="mi">200</span> <span class="n">non</span><span class="o">-</span><span class="n">root</span> <span class="n">channels</span><span class="p">,</span> <span class="mi">11</span> <span class="n">single</span><span class="o">-</span><span class="n">phone</span> <span class="n">words</span>
</pre></div>
</div>
<p>Now, you can start saying some words to check if the recognizer will be able to understand what you are saying. For example, try to say the following words:
.. code-block:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">hello</span>
<span class="n">go</span> <span class="n">to</span> <span class="n">the</span> <span class="n">room</span>
<span class="n">my</span> <span class="n">name</span> <span class="ow">is</span>
<span class="n">door</span>
<span class="n">follow</span> <span class="n">room</span>
</pre></div>
</div>
<p>You can also try different words.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It might be possible that the recognizer will detect words different from what you pronounced. This may be due to (1) bad microphone, in this case try to get a high-quality microphone, (2) your pronounciation is not enough clear. In this case, try to repeat the word.</p>
</div>
<p>If the recognizer successfuly detected your spoken word, you can move to the next step to talk to your robot.</p>
<p>The spoken words found by the recognizer will be published to the topic <code class="docutils literal"><span class="pre">/recognizer/output</span></code>. Type</p>
<div class="highlight-linux"><div class="highlight"><pre><span></span>rostopic echo /recognizer/output
</pre></div>
</div>
<p>in another terminal to see the results as follows:</p>
<div class="highlight-linux"><div class="highlight"><pre><span></span>data: go to the room
--
data: hello
--
</pre></div>
</div>
<p>To see all the predefined commands in the RoboCup demo, run the following commands:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">roscd</span> <span class="n">pocketsphinx</span><span class="o">/</span><span class="n">demo</span>
<span class="n">more</span> <span class="n">robocup</span><span class="p">.</span><span class="n">corpus</span>
</pre></div>
</div>
<p>Try saying a word that is not in the list such as &#8220;the food is hot&#8221; and see the results on the topic <code class="docutils literal"><span class="pre">/recognizer/output</span></code>, which will show something different. The recognizer will always try to find the nearest match to the word you say.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure that you mute the recognizer when not using it because this will send random data to the robot.</p>
</div>
</div>
<div class="section" id="code-and-dependencies">
<h2>Code and dependencies</h2>
<p>The scripts of voice teleoperation can be found in <code class="docutils literal"><span class="pre">gaitech_doc/src/turtlebot/voice_teleop/</span></code> that you imported from GITHUB. Make sure that you imported the code from GITHUB.
If you did not import the code from GITHUB, you can still create a new ROS package as follow:</p>
<blockquote>
<div><ul class="simple">
<li>Go to your catkin workspace and then go to <code class="docutils literal"><span class="pre">~/catkin_ws/src/</span></code></li>
<li>Create new a ROS package called <code class="docutils literal"><span class="pre">gaitech_doc</span></code> (or choose any other name) which depends on <code class="docutils literal"><span class="pre">pocketsphinx</span></code>, <code class="docutils literal"><span class="pre">roscpp</span></code>, <code class="docutils literal"><span class="pre">rospy</span></code>, <code class="docutils literal"><span class="pre">sound_play</span></code> and <code class="docutils literal"><span class="pre">std_msgs</span></code> as follow:</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">catkin_create_pkg</span> <span class="n">gaitech_doc</span> <span class="n">roscpp</span> <span class="n">rospy</span> <span class="n">pocketsphinx</span> <span class="n">sound_play</span> <span class="n">std_msgs</span>
</pre></div>
</div>
<ul class="simple">
<li>In the <code class="docutils literal"><span class="pre">~/catkin_ws/src/</span></code>, write the following command to see all the files and folders created:</li>
</ul>
</div></blockquote>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Remove the commented parts --&gt;</span>
<span class="nt">&lt;package&gt;</span>
 <span class="nt">&lt;name&gt;</span>gaitech_doc<span class="nt">&lt;/name&gt;</span>
 <span class="nt">&lt;version&gt;</span>0.0.1<span class="nt">&lt;/version&gt;</span>
 <span class="nt">&lt;description&gt;</span>gaitech_doc<span class="nt">&lt;/description&gt;</span>
 <span class="nt">&lt;maintainer</span> <span class="na">email=</span><span class="s">&quot;ros@todo.todo&quot;</span><span class="nt">&gt;</span>ros<span class="nt">&lt;/maintainer&gt;</span>
 <span class="nt">&lt;license&gt;</span>TODO<span class="nt">&lt;/license&gt;</span>
 <span class="nt">&lt;buildtool_depend&gt;</span>catkin<span class="nt">&lt;/buildtool_depend&gt;</span>
 <span class="nt">&lt;build_depend&gt;</span>pocketsphinx<span class="nt">&lt;/build_depend&gt;</span>
 <span class="nt">&lt;build_depend&gt;</span>roscpp<span class="nt">&lt;/build_depend&gt;</span>
 <span class="nt">&lt;build_depend&gt;</span>rospy<span class="nt">&lt;/build_depend&gt;</span>
 <span class="nt">&lt;build_depend&gt;</span>sound_play<span class="nt">&lt;/build_depend&gt;</span>
 <span class="nt">&lt;build_depend&gt;</span>std_msgs<span class="nt">&lt;/build_depend&gt;</span>
 <span class="nt">&lt;run_depend&gt;</span>pocketsphinx<span class="nt">&lt;/run_depend&gt;</span>
 <span class="nt">&lt;run_depend&gt;</span>roscpp<span class="nt">&lt;/run_depend&gt;</span>
 <span class="nt">&lt;run_depend&gt;</span>rospy<span class="nt">&lt;/run_depend&gt;</span>
 <span class="nt">&lt;run_depend&gt;</span>sound_play<span class="nt">&lt;/run_depend&gt;</span>
 <span class="nt">&lt;run_depend&gt;</span>std_msgs<span class="nt">&lt;/run_depend&gt;</span>
<span class="nt">&lt;/package&gt;</span>
</pre></div>
</div>
<p>Now, you are done with creating the ROS package.</p>
</div>
<div class="section" id="create-your-vocabulary-of-commands">
<h2>Create Your Vocabulary of Commands</h2>
<p>In this section, you will learn how to add a vocabulary or corpus as it is specified in the <code class="docutils literal"><span class="pre">PocketSphinx</span></code>.
In partiuclar, we will create a simple vocabulary of commands to move the turtlebot robot forward, backward, and rotate it left and right.</p>
<p>Create a folder and call it <code class="docutils literal"><span class="pre">config</span></code> and inside this folder create a <code class="docutils literal"><span class="pre">txt</span></code> file called <code class="docutils literal"><span class="pre">motion_commands.txt</span></code>
and put the following commands (which you can extend more later) for the robot motion:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">move</span> <span class="n">forward</span>
<span class="n">move</span> <span class="n">backwards</span>
<span class="n">turn</span> <span class="n">right</span>
<span class="n">turn</span> <span class="n">left</span>
</pre></div>
</div>
<p>Feel free to add/delete/change any command you want as long as you follow the conventions.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Do not use punctuation marks and pay attention to the upper and lower case letters.
If you want to add a number you will have to spell it so you can not write 1, 55, 87..etc instead write one, fifty five, eighty seven.</p>
</div>
<p>After editing the <code class="docutils literal"><span class="pre">motion_commands.txt</span></code> file, you have to compile it into special dictionary and pronounciation files so it matches the specification for the <code class="docutils literal"><span class="pre">PocketSphinx</span></code>.
The online CMU language model (lm) tool is very useful in this case, visit their <a class="reference external" href="http://www.speech.cs.cmu.edu/tools/lmtool-new.html">website</a><span class="link-target"> [http://www.speech.cs.cmu.edu/tools/lmtool-new.html]</span>  and  upload your file.
Click on the Compile Knowledge Base button, then download the file labeled <code class="docutils literal"><span class="pre">COMPRESSED</span> <span class="pre">TARBALL</span></code> that contains all the language model files
that you need and the <code class="docutils literal"><span class="pre">PocketSphinx</span></code> can understand.</p>
<p>Extract these files into the config subdirectory of the <code class="docutils literal"><span class="pre">gaitech_doc</span></code> package (or your package where you are working this example). These files must be provided as an input parameter to <code class="docutils literal"><span class="pre">recognizer.py</span></code> node.
To do so, you need to create a launch file as follow.</p>
<blockquote>
<div><ul class="simple">
<li>First, create a folder and call it <code class="docutils literal"><span class="pre">launch</span></code> where to create launch files</li>
<li>Then, create a file called <code class="docutils literal"><span class="pre">voice_teleop.launch</span></code>, and add the following XML code:</li>
</ul>
</div></blockquote>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="nt">&lt;launch&gt;</span>
     <span class="nt">&lt;node</span> <span class="na">name=</span><span class="s">&quot;recognizer&quot;</span> <span class="na">pkg=</span><span class="s">&quot;pocketsphinx&quot;</span> <span class="na">type=</span><span class="s">&quot;recognizer.py&quot;</span> <span class="na">output=</span><span class="s">&quot;screen&quot;</span><span class="nt">&gt;</span>
       <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;lm&quot;</span> <span class="na">value=</span><span class="s">&quot;$(find gaitech_doc)/turtlebot/voice_teleop/config/motion_commands.lm&quot;</span><span class="nt">/&gt;</span>
       <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;dict&quot;</span> <span class="na">value=</span><span class="s">&quot;$(find gaitech_doc)/turtlebot/voice_teleop/config/motion_commands.dic&quot;</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/node&gt;</span>
<span class="nt">&lt;/launch&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If your package name is different from <code class="docutils literal"><span class="pre">gaitech_doc</span></code> make sure to consider this in the instruction <code class="docutils literal"><span class="pre">value=&quot;$(find</span> <span class="pre">gaitech_doc)</span></code> of the launch file. Otherwise, ROS will not be able to find the parameters
Make sure that you put the correct path for the <code class="docutils literal"><span class="pre">lm</span></code> and <code class="docutils literal"><span class="pre">dic</span></code> files.</p>
</div>
<p>This file runs the <code class="docutils literal"><span class="pre">recognizer.py</span></code> node from the <code class="docutils literal"><span class="pre">pocketsphinx</span></code> package mentioned before in this tutorial.
The <code class="docutils literal"><span class="pre">lm</span></code> and <code class="docutils literal"><span class="pre">dict</span></code> parameters are mentioned how are they created and what is their use in the files <code class="docutils literal"><span class="pre">motion_commands.lm</span></code> and <code class="docutils literal"><span class="pre">motion_commands.dic</span></code> created in the previous step.
The last parameter which is <code class="docutils literal"><span class="pre">output=&quot;screen&quot;</span></code> is used to let us see in real-time the recognition results in the launch window.</p>
<p>Launch the <code class="docutils literal"><span class="pre">voice_teleop.launch</span></code> file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>roslaunch gaitech_doc voice_teleop.launch
</pre></div>
</div>
<p>and in another terminal run the following command to see the published topics after giving the robot a couple of commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>rostopic <span class="nb">echo</span> /recognizer/output
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to close all the running launch files and all the demos running from previous examples before you run the previous commands.</p>
</div>
</div>
<div class="section" id="a-voice-control-navigation-script">
<h2>A Voice-Control Navigation Script</h2>
<p>As mentioned before the <code class="docutils literal"><span class="pre">recognizer.py</span></code> node in the <cite>pocketsphinx</cite> package publishes a topic called <code class="docutils literal"><span class="pre">/recognizer/output</span></code>. But there must be a file that subscribes to this topic and gives orders to the robot according to the commands given by the user.
The <code class="docutils literal"><span class="pre">voice_nav.py</span></code> file in the <cite>pocketsphinx</cite> package maps the commands into <cite>Twist</cite> messages that can be used to control your turtlebot robot.
You can find this file in the <code class="docutils literal"><span class="pre">turtlebot_cont_movement/nodes</span></code> subdirectory.</p>
</div>
<div class="section" id="code-explanation">
<h2>Code Explanation</h2>
<p>This is the content of the <code class="docutils literal"><span class="pre">voice_nav.py</span></code> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">voice_nav.py - Version 1.1 2013-12-20</span>

<span class="sd">Allows controlling a mobile base using simple speech commands.</span>

<span class="sd">Based on the voice_cmd_vel.py script by Michael Ferguson in</span>
<span class="sd">the pocketsphinx ROS package.</span>

<span class="sd">See http://www.ros.org/wiki/pocketsphinx</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">copysign</span>

<span class="k">class</span> <span class="nc">VoiceNav</span><span class="p">:</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;voice_nav&#39;</span><span class="p">)</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>

    <span class="c1"># Set a number of parameters affecting the robot&#39;s speed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~max_speed&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_speed</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~max_angular_speed&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~start_speed&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~start_angular_speed&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~linear_increment&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~angular_increment&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># We don&#39;t have to run the script very fast</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s2">&quot;~rate&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>

    <span class="c1"># A flag to determine whether or not voice control is paused</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Initialize the Twist message we will publish.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

    <span class="c1"># Publish the Twist message to the cmd_vel topic</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Subscribe to the /recognizer/output topic to receive voice commands.</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/recognizer/output&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">speech_callback</span><span class="p">)</span>

    <span class="c1"># A mapping from keywords or phrases to commands</span>
    <span class="c1">#These are different kinds of commands you can give to the robot and you can delete/add any command you want.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keywords_to_command</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;halt&#39;</span><span class="p">,</span> <span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;panic&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">,</span> <span class="s1">&#39;shut down&#39;</span><span class="p">,</span> <span class="s1">&#39;turn off&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;help me&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;slower&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;slow down&#39;</span><span class="p">,</span> <span class="s1">&#39;slower&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;faster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;speed up&#39;</span><span class="p">,</span> <span class="s1">&#39;faster&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;ahead&#39;</span><span class="p">,</span> <span class="s1">&#39;straight&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="s1">&#39;back up&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;rotate left&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rotate left&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;rotate right&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rotate right&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;turn left&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;turn left&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;turn right&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;turn right&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;quarter speed&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;half&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;half speed&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;full speed&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;pause&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pause speech&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;continue&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue speech&#39;</span><span class="p">]}</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Ready to receive voice commands&quot;</span><span class="p">)</span>

    <span class="c1"># We have to keep publishing the cmd_vel message if we want the robot to keep moving.</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Attempt to match the recognized word or phrase to the</span>
    <span class="c1"># keywords_to_command dictionary and return the appropriate</span>
    <span class="c1"># command</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords_to_command</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">command</span>

<span class="k">def</span> <span class="nf">speech_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="c1"># Get the motion command from the recognized phrase</span>
    <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Log the command to the screen</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Command: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

    <span class="c1"># If the user has asked to pause/continue voice control,</span>
    <span class="c1"># set the flag accordingly</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;pause&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;continue&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># If voice control is paused, simply return without</span>
    <span class="c1"># performing any action</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># The list of if-then statements should be fairly</span>
    <span class="c1"># self-explanatory</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;rotate left&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;rotate right&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;turn left&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;turn right&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
        <span class="c1"># Stop the robot!  Publish a Twist message consisting of all zeros.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;faster&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">+=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;slower&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">-=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">,</span> <span class="s1">&#39;half&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;quarter&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;half&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_speed</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># When shutting down be sure to stop the robot!</span>
    <span class="n">twist</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_vel_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">twist</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
      <span class="n">VoiceNav</span><span class="p">()</span>
      <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
 <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
      <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Voice navigation terminated.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The code is very well commented but maybe a few lines need more explanation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># A mapping from keywords or phrases to commands</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">keywords_to_command</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;halt&#39;</span><span class="p">,</span> <span class="s1">&#39;abort&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;panic&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">,</span> <span class="s1">&#39;shut down&#39;</span><span class="p">,</span> <span class="s1">&#39;turn off&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;help me&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;slower&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;slow down&#39;</span><span class="p">,</span> <span class="s1">&#39;slower&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;faster&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;speed up&#39;</span><span class="p">,</span> <span class="s1">&#39;faster&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;ahead&#39;</span><span class="p">,</span> <span class="s1">&#39;straight&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="s1">&#39;back up&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;rotate left&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rotate left&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;rotate right&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rotate right&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;turn left&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;turn left&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;turn right&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;turn right&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;quarter speed&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;half&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;half speed&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;full speed&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;pause&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pause speech&#39;</span><span class="p">],</span>
                                                                                                                                     <span class="s1">&#39;continue&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;continue speech&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>The <cite>keywords_to_command</cite> Python dictionary allows the mapping between the commands/phrases given to the robot and the actual movement of the robot. You will notice that there are a couple of alternatives for the word &#8220;stop&#8221; in case the robot is not responding the &#8220;stop&#8221; word such as (help, halt, abort..etc) and they are all recognized by the <cite>PocketSphinx</cite> vocabulary.
So after the <code class="docutils literal"><span class="pre">voice_nav.py</span></code> node subscribes to the <code class="docutils literal"><span class="pre">/recognizer/output</span></code> topic it searched for any recognizable commands/phrases to convert them into <cite>Twist</cite> actions so the robot can understand.
The <code class="docutils literal"><span class="pre">voice_nav.py</span></code> script has another great feature that allows the robot to stop or continue taking orders from user if the user says the command &#8220;pause speech&#8221; or &#8220;continue speech&#8221;. This will be very useful in case the user is having a conversation with someone else.</p>
<p>Now create another launch file called <cite>turtlebot_voice_cont_movement.launch</cite> and its content should be:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">launch</span><span class="o">&gt;</span>
 <span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;voice_nav&quot;</span> <span class="n">pkg</span><span class="o">=</span><span class="s2">&quot;turtlebot_cont_movement&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;voice_nav.py&quot;</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="o">&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;scale_linear&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;double&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;scale_angular&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;1.5&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;double&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;max_speed&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.3&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;start_speed&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;linear_increment&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.05&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;</span><span class="n">param</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;angular_increment&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0.4&quot;</span><span class="o">/&gt;</span>
 <span class="o">&lt;/</span><span class="n">node</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">launch</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This file controls the speed of the robot while moving.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The increment speed parameters will be used when you add a command related to them such as <cite>go faster</cite>, <cite>faster</cite> or <cite>go slower</cite>, <cite>slow</cite></p>
</div>
</div>
<div class="section" id="testing-the-voice-control-in-the-gazebo-and-stage-simulators">
<h2>Testing the Voice-Control in the Gazebo and Stage Simulators</h2>
<p>This section introduce how to test the voice recognition with the Gazebo and Stage simulators.</p>
<p>Now let&#8217;s bring up <cite>Gazebo</cite>  with the simulation config file:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_gazebo</span> <span class="pre">turtlebot_world.launch</span></code></p>
<p>OR</p>
<p>Bring up <cite>Stage</cite>  simulator using the following command:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_stage</span> <span class="pre">turtlebot_in_stage_no_rviz.launch</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These simulators requires a powerful PC with a good graphics card that can launch them. They also may crash once you start them but don&#8217;t worry this is very normal, just rerun the script until it launches.</p>
</div>
<p>To able to view the commands that are recognizable by the robot we have to run the <code class="docutils literal"><span class="pre">rqt_console</span></code> using the following command:</p>
<p><code class="docutils literal"><span class="pre">rqt_console</span> <span class="pre">&amp;</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to check your Mic settings as discribed before.</p>
</div>
<p>Run the cont_movement.launch file which runs the <code class="docutils literal"><span class="pre">voice_nav.py</span></code> file:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_cont_movement</span> <span class="pre">cont_movement.launch</span></code></p>
<p>The following command is responsible for controlling the speed of the robot:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_cont_movement</span> <span class="pre">turtlebot_voice_cont_movement.launch</span></code></p>
<p>Now test your robot by giving it any command from the list mentiond previously.</p>
</div>
<div class="section" id="testing-the-voice-control-with-a-turtlebot-robot">
<h2>Testing the Voice-Control with a Turtlebot Robot</h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before you test the robot make sure that your robot is in an open space with no obstacles or edges next to it.</p>
</div>
<p>From the ROS Master node(the Turtlebot&#8217;s laptop) run the following commands:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">rbx1_bringup</span> <span class="pre">turtlebot_minimal_create.launch</span></code></p>
<p>To make the monitoring process easier bring up <cite>rqt_console</cite> by running:</p>
<p><code class="docutils literal"><span class="pre">rqt_console</span> <span class="pre">&amp;</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Check your sound settings as mentioned before.</p>
</div>
<p>On the host node(the user PC) run the <code class="docutils literal"><span class="pre">cont_movement.launch</span></code> file:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_cont_movement</span> <span class="pre">cont_movement.launch</span></code></p>
<p>and in another terminal run the following command:</p>
<p><code class="docutils literal"><span class="pre">roslaunch</span> <span class="pre">turtlebot_cont_movement</span> <span class="pre">turtlebot_voice_cont_movement.launch</span></code></p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Try a simple command at first like the rotate right to avoid any accidents. You can change the robot&#8217;s speed by giving the command &#8220;go faster&#8221; or &#8220;slow down&#8221; and this will change the parameters for speed in the turtlebot_voice_nav.launch file. However, you will have to add the commands as mentioned previously in the <cite>config/cont_movement.txt</cite> file and redo all he steps again.</p>
</div>
<p>##import: speech-video in this location</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Gaitech.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>